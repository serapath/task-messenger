module.exports = [require, ana_data_vault]

async function ana_data_vault (node) {
  const { require, spawn, config } = node
  const tasks = {}

  console.log('ANA-DATA-VAULT:', config)


  document.body.style = 'margin: 0; height: 100vh; display: flex; flex-direction: column;'
  const grid = document.createElement('div')
  grid.style = 'box-sizing: border-box; background-color: #333; color: white; display: flex; flex-direction: column; flex-grow: 1;'
  document.body.innerHTML = `<h1 style="margin:0;">ana-data-vault</h1>`
  document.body.append(grid)


  Object.keys(config).map(name => {
    const app = Object.assign(document.createElement('div'), { id: name })
    const randomHsl = () => `hsla(${Math.random() * 360}, 100%, 65%, 1)`
    const c = randomHsl()
    app.style = `box-sizing: border-box; padding: 2px; flex-grow: 1; background-color: ${c};`
    const shadow = app.attachShadow({ mode: 'closed' })
    shadow.append(spawn(name, config[name], port => {
      port.onmessage = onmessage
      tasks[name] = port
    }))
    function onmessage ({ data, ports: [port] }) {
      console.log(`%c[(vault)]%c[by ${name.toUpperCase()}] recv`, 'color:green;', 'color:white;', data, port)
      console.log('@TODO: set up interaction')
    }
    grid.append(app)
  })
}